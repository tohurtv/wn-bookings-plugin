{% put styles %}
<link rel="stylesheet" href="/plugins/tohur/bookings/assets/css/bootstrap-datepicker.min.css" crossorigin="anonymous">
<style>
#booking-date-picker .form-control {
  height: 34px;          /* typical Bootstrap small input height */
  padding: 0.25rem 0.5rem; 
  font-size: 0.875rem;
  line-height: 1.25;     /* adjust line height */
}
</style>
{% endput %}

{% put scripts %}
<script src="/plugins/tohur/bookings/assets/js/bootstrap-datepicker.min.js" crossorigin="anonymous"></script>

<script>
    const workingSchedule = {{ settings.working_schedule|json_encode|raw }};
    const interval = {{ settings.booking_interval|default(15) }};

    function getDayName(date) {
        return date.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
    }

    function getTimesForDay(dayName) {
        const day = workingSchedule.find(s => s.day.toLowerCase() === dayName);
        if (!day) return [];

        const times = [];
        const blocks = day.time_blocks || [];

        for (let block of blocks) {
            let from = parseTime(block.from);
            let to = parseTime(block.to);

            while (from < to) {
                times.push(formatTime(from));
                from.setMinutes(from.getMinutes() + interval);
            }
        }

        return times;
    }

    function parseTime(timeStr) {
        const [h, m] = timeStr.split(':');
        const date = new Date();
        date.setHours(+h, +m, 0, 0);
        return date;
    }

    function formatTime(date) {
        return date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
    }

    $(function() {
        // Determine which days to disable based on workingSchedule
        const dayNames = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
        const enabledDays = workingSchedule.map(day => dayNames.indexOf(day.day.toLowerCase()));

        $('#booking-date-picker').datepicker({
            format: 'yyyy-mm-dd',
            startDate: new Date(),
            daysOfWeekDisabled: [0,1,2,3,4,5,6].filter(d => !enabledDays.includes(d)),
            autoclose: true,
            todayHighlight: true
        });

        // When a date is selected
        $('#booking-date-picker').on('changeDate', function(e) {
            const selectedDate = e.date;
            const dayName = getDayName(selectedDate);
            updateTimeSlots(dayName);
        });

        function updateTimeSlots(dayName) {
            const times = getTimesForDay(dayName);

            const wrapper = document.getElementById('time-slot-wrapper');
            const list = document.getElementById('available-times');
            const bookBtn = document.getElementById('book-now');

            list.innerHTML = '';

            if (times.length === 0) {
                wrapper.classList.add('d-none');
                bookBtn.style.display = 'none';
                return;
            }

            wrapper.classList.remove('d-none');

            times.forEach(time => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-outline-primary';
                btn.innerText = time;
                btn.onclick = () => {
                    document.getElementById('booking_time').value = time;
                    Array.from(list.children).forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    bookBtn.style.display = 'inline-block';
                };
                list.appendChild(btn);
            });
        }
    });
</script>
{% endput %}
